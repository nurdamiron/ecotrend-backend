# Руководство по переходу на модель прямой оплаты EcoTrend

Этот документ описывает процесс миграции с модели предоплаченного баланса на модель прямой оплаты каждой операции дозирования в системе EcoTrend.

## Обзор архитектурных изменений

### Старая модель (с балансом)
1. Пользователь пополнял баланс устройства через Kaspi
2. Баланс сохранялся в БД и Firebase
3. При дозировании средства списывались с баланса

### Новая модель (прямая оплата)
1. Пользователь выбирает химикат и объем
2. Система рассчитывает стоимость
3. Пользователь сканирует QR-код для оплаты точной суммы
4. После подтверждения оплаты происходит дозирование

## Изменения в структуре БД

1. **Добавлена таблица `flow_states`**
   - Отслеживает весь процесс от выбора химиката до дозирования
   - Содержит ID сессии, этап процесса, выбранный химикат, объем, сумму

2. **Обновлена таблица `transactions`**
   - Добавлены поля `tank_number`, `chemical_name`, `volume`
   - Добавлено поле `dispensed` для отслеживания завершения дозирования

3. **Таблица `balances` больше не используется**
   - Можно оставить для совместимости или удалить

## Процесс миграции

### 1. Подготовка к миграции

Перед началом миграции рекомендуется:
- Создать резервную копию базы данных
- Заранее уведомить пользователей о предстоящих изменениях
- Запланировать окно обслуживания для миграции

### 2. Применение миграции SQL

Запустите SQL-миграцию для обновления структуры БД:

```bash
# Для применения миграции
node scripts/migrate.js

# Или вручную
mysql -u username -p ecotrend < migrations/20250413000000_direct_payment_model.sql
```

### 3. Обновление кода

1. Обновите все файлы API согласно новой архитектуре:
   - Контроллеры: `dispensingController.js`, `kaspiController.js`
   - Маршруты: `dispensingRoutes.js`, `kaspiRoutes.js`
   - Модели: `dispensingModel.js`, `transactionModel.js`
   - Добавьте новые файлы: `flowStateModel.js`

2. Обновите `server.js` для использования новых маршрутов

### 4. Проверка и тестирование

1. Запустите тесты для проверки нового функционала:
   ```bash
   npm test
   ```

2. Проведите ручное тестирование основных сценариев:
   - Расчет стоимости
   - Генерация QR-кода
   - Эмуляция процесса оплаты
   - Выполнение дозирования

### 5. Обработка существующих балансов

Для пользователей, у которых есть остаток на балансе, рекомендуется:
1. Предоставить переходный период, в течение которого они могут использовать свой баланс
2. Или вернуть неиспользованные средства

## Обновление мобильного приложения

Мобильное приложение также потребует обновления для поддержки новой модели:

1. Обновите экраны для отображения выбора химиката и объема
2. Добавьте функционал для расчета стоимости
3. Интегрируйте сканирование QR-кода для оплаты
4. Обновите логику отслеживания состояния операции

## Обновление Firebase

1. Обновите структуру данных Firebase:
   - Удалите поля баланса из данных устройств
   - Добавьте новые поля для отслеживания операций дозирования

2. Обновите правила безопасности Firebase

## Изменения в API

### Новые endpoints

1. `POST /api/dispensing/calculate` - Расчет стоимости дозирования
2. `GET /api/dispensing/status/{sessionId}` - Проверка статуса операции
3. `POST /api/dispensing/{sessionId}/dispense` - Выполнение дозирования
4. `GET /api/kaspi/generate-qr/{sessionId}` - Генерация QR-кода для оплаты

### Удаленные endpoints

1. `GET /api/balance/{deviceId}` - Получение баланса устройства
2. `POST /api/balance/{deviceId}/update` - Обновление баланса
3. `GET /api/balance/{deviceId}/transactions` - История транзакций

## Преимущества новой модели

1. **Прозрачность для пользователей**
   - Каждая операция оплачивается напрямую
   - Нет необходимости в предоплате

2. **Упрощение системы**
   - Нет необходимости отслеживать и обновлять баланс
   - Меньше состояний для синхронизации между БД и Firebase

3. **Улучшение безопасности**
   - Каждая транзакция проверяется Kaspi
   - Отсутствие риска несанкционированного списания баланса

## Поддержка и обратная связь

При возникновении проблем с миграцией обращайтесь по адресу nurdamiron@gmail.com.